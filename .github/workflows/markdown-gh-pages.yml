name: Build Static Content
on:
  workflow_dispatch:
  push:
    branches:
      - 'main'

jobs:
  Markdown-Lint:
    runs-on: docs-runner-set-4
    container:
      image: alpine:3.16.2
    #defaults:
      #run:
       # working-directory: /
    environment: k8s
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - run: |
          echo "ðŸŽ‰ Starting markdown lint!"
          ls -lta
          apk add --update --no-cache ruby-full && gem install mdl --no-document
          mdl . -s .markdownlint.rb | tee ./md-lint.txt
      - uses: actions/upload-artifact@v3
        with:
          name: md-lint
          path: md-lint.txt

  Yaml-Lint:
    runs-on: docs-runner-set-4
    container:
      image: cytopia/yamllint:1
    environment: k8s
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - run: |
          echo "ðŸŽ‰ Starting yaml lint!"
          ls -lta
          yamllint . --format github | tee ./yaml-lint.txt
      - uses: actions/upload-artifact@v3
        with:
          name: yaml-lint
          path: yaml-lint.txt

  Create-Hugo-Site:
    runs-on: docs-runner-set-4
    container:
      image: klakegg/hugo:0.107.0-ext-alpine
    environment: k8s
    continue-on-error: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - run: |
          echo "Creating hugo blog"
          hugo new site blog -f "yaml"
          mkdir -p ./blog/content/docs/docs
          cp -R *.md ./blog/content/docs/docs
          cp -R hugo/config.yaml ./blog
          git clone https://github.com/alex-shpak/hugo-book ./blog/themes/hugo-book
          ls -lta ./blog
          ls -lta ./blog/themes
          ls -lta ./blog/content/docs/docs
          cd blog && hugo --verbose --destination ../public
      - uses: actions/upload-artifact@v3
        with:
          name: hugo-public
          path: public
      - uses: actions/upload-pages-artifact@v1
        with:
          path: public

 # Trivy:
 #   runs-on: docs-runner-set-4
 #   container: aquasec/trivy:0.46.0
 #   environment: k8s
 #   steps:
 #     - run: |
 #         echo "ðŸŽ‰ TRIVY!"
 #         cat /etc/os-release
 #         whoami
 #         ls -lta
 #         trivy version
 #         trivy image python:3.4-alpine
 #         echo ${{secrets.KUBECONFIG}}
